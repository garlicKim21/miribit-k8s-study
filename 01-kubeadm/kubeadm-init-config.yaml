# ========================================
# 첫 번째 컨트롤 플레인 노드 초기화 설정 파일
# 사용법: kubeadm init --config=kubeadm-init-config.yaml --upload-certs
# 대상 노드: k8s-u80-ctrl-1.local (192.168.104.81)
# ========================================

apiVersion: kubeadm.k8s.io/v1beta4
kind: InitConfiguration
# InitConfiguration: 클러스터를 처음 초기화할 때 사용하는 설정
# 첫 번째 컨트롤 플레인 노드에서만 사용됩니다.

localAPIEndpoint:
  # advertiseAddress: 이 노드가 API 서버로 사용할 IP 주소
  # 첫 번째 컨트롤 플레인 노드의 실제 IP 주소를 사용합니다.
  advertiseAddress: 192.168.104.81        # 사용자 번호에 맞게 반드시 IP 주소를 수정하여 사용해야 합니다!
  # bindPort: API 서버가 바인딩할 포트 번호
  bindPort: 6443

nodeRegistration:
  # criSocket: 컨테이너 런타임 인터페이스 소켓 경로
  # containerd를 사용하므로 이 경로를 지정합니다.
  criSocket: unix:///var/run/containerd/containerd.sock
  
  # imagePullPolicy: 이미지 풀 정책
  # IfNotPresent: 로컬에 없을 때만 풀링
  imagePullPolicy: IfNotPresent
  
  # imagePullSerial: 이미지를 순차적으로 풀링할지 여부
  # true: 순차적으로 (네트워크 부하 감소)
  imagePullSerial: true
  
  # name: 이 노드의 이름 (호스트명과 일치시켜야 함)
  name: k8s-u80-ctrl-1.local                   # 사용자 번호에 맞게 반드시 호스트명을 수정하여 사용해야 합니다!
  
  # taints: 노드에 적용할 테인트
  # control-plane 노드는 기본적으로 Pod 스케줄링을 제한합니다.
  taints:
  - effect: NoSchedule
    key: node-role.kubernetes.io/control-plane

# timeouts: 각 작업의 타임아웃 설정
timeouts:
  controlPlaneComponentHealthCheck: 4m0s  # 컨트롤 플레인 컴포넌트 건강 상태 확인
  discovery: 5m0s                          # 노드 발견 타임아웃
  etcdAPICall: 2m0s                        # etcd API 호출 타임아웃
  kubeletHealthCheck: 1m0s                 # kubelet 건강 상태 확인
  kubernetesAPICall: 4m0s                  # Kubernetes API 호출 타임아웃
  tlsBootstrap: 5m0s                       # TLS 부트스트랩 타임아웃
  upgradeManifests: 5m0s                   # 매니페스트 업그레이드 타임아웃

---
# YAML 문서 구분자: 여러 설정을 하나의 파일에 포함할 수 있습니다.

apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
# ClusterConfiguration: 클러스터 전체 설정
# 모든 노드에서 공통으로 사용되는 설정입니다.

# apiServer: API 서버 설정
apiServer:
  # certSANs: API 서버 인증서에 포함될 추가 Subject Alternative Names
  # HAProxy VIP와 모든 컨트롤 플레인 노드의 IP를 포함해야 합니다.
  # 이렇게 하면 kubectl이 HAProxy VIP를 통해 접근할 때 인증서 오류가 발생하지 않습니다.
  certSANs:
  - 192.168.104.80  # HAProxy VIP (필수!)                      #사용자 번호에 맞게 반드시 IP 주소를 수정하여 사용해야 합니다!
  - 192.168.104.81  # 첫 번째 컨트롤 플레인 노드                    # 사용자 번호에 맞게 반드시 IP 주소를 수정하여 사용해야 합니다!
  - 192.168.104.82  # 두 번째 컨트롤 플레인 노드                    # 사용자 번호에 맞게 반드시 IP 주소를 수정하여 사용해야 합니다!
  - 192.168.104.83  # 세 번째 컨트롤 플레인 노드                    # 사용자 번호에 맞게 반드시 IP 주소를 수정하여 사용해야 합니다!
  - k8s-u80-ctrl-1.local  # 첫 번째 컨트롤 플레인 호스트명                # 사용자 번호에 맞게 반드시 호스트명을 수정하여 사용해야 합니다!
  - k8s-u80-ctrl-2.local  # 두 번째 컨트롤 플레인 호스트명                # 사용자 번호에 맞게 반드시 호스트명을 수정하여 사용해야 합니다!
  - k8s-u80-ctrl-3.local  # 세 번째 컨트롤 플레인 호스트명                # 사용자 번호에 맞게 반드시 호스트명을 수정하여 사용해야 합니다!
  - 127.0.0.1       # localhost
  - localhost       # localhost 호스트명

# caCertificateValidityPeriod: CA 인증서 유효 기간
# 87600시간 = 약 10년
caCertificateValidityPeriod: 87600h0m0s

# certificateValidityPeriod: 일반 인증서 유효 기간
# 8760시간 = 1년
certificateValidityPeriod: 8760h0m0s

# certificatesDir: 인증서가 저장될 디렉토리
certificatesDir: /etc/kubernetes/pki

# clusterName: 클러스터 이름
clusterName: kubernetes

# controlPlaneEndpoint: 컨트롤 플레인 엔드포인트 (HAProxy VIP)
# 이 주소로 모든 노드가 API 서버에 접근합니다.
# HAProxy가 로드밸런싱을 담당합니다.
controlPlaneEndpoint: 192.168.104.80:6443

# controllerManager: 컨트롤러 매니저 설정 (기본값 사용)
controllerManager: {}

# dns: DNS 설정 (기본값 사용)
dns: {}

# encryptionAlgorithm: 암호화 알고리즘
# RSA-2048: 2048비트 RSA 키 사용
encryptionAlgorithm: RSA-2048

# etcd: etcd 설정
etcd:
  local:
    # dataDir: etcd 데이터 디렉토리
    dataDir: /var/lib/etcd

# imageRepository: 컨테이너 이미지 저장소
# registry.k8s.io: Kubernetes 공식 이미지 저장소
imageRepository: registry.k8s.io

# kubernetesVersion: 설치할 Kubernetes 버전
kubernetesVersion: v1.34.1

# networking: 네트워크 설정
networking:
  # dnsDomain: DNS 도메인
  # Pod의 FQDN은 <pod-name>.<namespace>.svc.<dnsDomain> 형식입니다.
  dnsDomain: cluster.local
  
  # podSubnet: Pod에 할당할 IP 대역
  # CNI 플러그인이 이 대역에서 IP를 할당합니다.
  podSubnet: 10.244.0.0/16
  
  # serviceSubnet: Service에 할당할 IP 대역
  # ClusterIP 서비스의 IP가 이 대역에서 할당됩니다.
  serviceSubnet: 10.96.0.0/12

# proxy: kube-proxy 설정 (기본값 사용)
# CNI 플러그인(Cilium 등)을 사용하는 경우 비워둡니다.
proxy: {}

# scheduler: 스케줄러 설정 (기본값 사용)
scheduler: {}

